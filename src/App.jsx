import { useState } from 'react';
import { useSpeechRecognition } from './hooks/useSpeechRecognition';
import { useAnalysis } from './hooks/useAnalysis';
import { TranscriptPanel } from './components/TranscriptPanel';
import { InsightCard } from './components/InsightCard';

export default function App() {
  const {
    isListening,
    transcript,
    interimText,
    isSupported,
    startListening,
    stopListening,
  } = useSpeechRecognition();

  const { blocks, isAnalyzing, error, analyzeText, countdown } = useAnalysis(transcript, isListening);
  const [pastedText, setPastedText] = useState('');
  const [showPasteArea, setShowPasteArea] = useState(false);

  async function handlePasteAnalyze() {
    const text = pastedText.trim();
    if (!text) return;
    await analyzeText(text);
    setShowPasteArea(false);
  }

  const displayTranscript = pastedText || transcript;

  if (!isSupported) {
    return (
      <div className="app">
        <div className="unsupported">
          <MeetaLogo className="logo-img" />
          <p>
            Web Speech API wordt niet ondersteund in deze browser. Gebruik
            Chrome of Edge.
          </p>
        </div>
      </div>
    );
  }

  return (
    <div className="app">
      <div className="layout">
        <aside className="sidebar">
          <header className="header">
            <MeetaLogo className="logo-img" />
            <div className="header-actions">
              <button
                className="btn btn-paste-toggle"
                onClick={() => setShowPasteArea(!showPasteArea)}
                title="Plak transcript"
              >
                <PasteIcon />
              </button>
              {isListening ? (
                <button className="btn btn-stop" onClick={stopListening}>
                  <StopIcon /> Stop
                </button>
              ) : (
                <button className="btn btn-start" onClick={startListening}>
                  <MicIcon /> Start
                </button>
              )}
            </div>
          </header>

          {showPasteArea && (
            <div className="paste-area">
              <textarea
                className="paste-textarea"
                placeholder="Plak hier een transcript..."
                value={pastedText}
                onChange={(e) => setPastedText(e.target.value)}
                rows={5}
              />
              <div className="paste-actions">
                <button
                  className="btn btn-start"
                  onClick={handlePasteAnalyze}
                  disabled={!pastedText.trim() || isAnalyzing}
                >
                  {isAnalyzing ? 'Analyseren...' : 'Analyseer'}
                </button>
                <button
                  className="btn"
                  onClick={() => { setPastedText(''); setShowPasteArea(false); }}
                >
                  Annuleer
                </button>
              </div>
            </div>
          )}

          {isListening && (
            <div className="countdown-bar">
              <div
                className="countdown-progress"
                style={{ width: `${((45 - countdown) / 45) * 100}%` }}
              />
              <span className="countdown-text">
                {isAnalyzing ? 'Analyseren...' : `Analyse over ${countdown}s`}
              </span>
            </div>
          )}

          <TranscriptPanel
            transcript={displayTranscript}
            interimText={interimText}
            isListening={isListening}
          />
        </aside>

        <main className="main">
          {error && <div className="error-banner">{error}</div>}

          {blocks.length > 0 ? (
            <div className="insights-grid">
              {blocks.map((block, i) => (
                <InsightCard key={`${block.type}-${i}`} block={block} index={i} />
              ))}
            </div>
          ) : (
            <div className="empty-state">
              <MeetaLogo className="empty-logo" />
            </div>
          )}
        </main>
      </div>
    </div>
  );
}

function MeetaLogo({ className }) {
  return (
    <svg className={className} viewBox="0 0 479 98" fill="none" xmlns="http://www.w3.org/2000/svg">
      <circle cx="48.5056" cy="48.5056" r="48.5056" fill="#D9D9D9"/>
      <circle cx="430.224" cy="48.5056" r="48.5056" fill="#D9D9D9"/>
      <path d="M320.558 0C347.347 0 369.064 21.7169 369.064 48.5059C369.064 75.0855 347.685 96.6714 321.185 97.0068L320.558 97.0117H156.061V96.9648C130.251 95.8606 109.665 74.588 109.665 48.5059C109.665 22.4236 130.251 1.14917 156.061 0.0449219V0H320.558Z" fill="#EBFF00"/>
      <path d="M318.997 68.2796C317.057 68.2796 315.514 67.8387 314.368 66.9571C313.266 66.0754 312.605 64.819 312.384 63.1879L311.855 62.9895C311.018 63.8712 310.136 64.7088 309.21 65.5023C308.284 66.2517 307.425 66.8689 306.631 67.3538C305.838 67.7947 305.155 68.0151 304.581 68.0151C302.862 68.0151 301.319 67.5963 299.953 66.7587C298.586 65.9211 297.506 64.7749 296.712 63.3202C295.919 61.8654 295.522 60.2343 295.522 58.4269C295.522 57.0603 295.875 55.8921 296.58 54.9222C297.33 53.9083 298.255 53.2471 299.357 52.9385L312.12 49.9628L312.186 48.3758C312.186 46.4802 311.679 45.0034 310.665 43.9454C309.695 42.8874 308.306 42.3584 306.499 42.3584C305.265 42.3584 303.942 42.667 302.532 43.2841C301.121 43.8572 299.864 44.5846 298.762 45.4663L298.167 45.2018L297.043 41.2343C298.322 40.4848 299.754 39.7354 301.341 38.986C302.928 38.1925 304.427 37.5312 305.838 37.0022C307.293 36.4732 308.395 36.2087 309.144 36.2087C311.701 36.2087 313.795 36.6055 315.426 37.399C317.057 38.1925 318.247 39.2725 318.997 40.6391C319.746 41.9616 320.121 43.4825 320.121 45.2018C320.121 45.7749 320.055 46.6566 319.923 47.8468C319.79 49.0371 319.636 50.3375 319.46 51.7482C319.283 53.1589 319.129 54.5034 318.997 55.7819C318.865 57.0603 318.798 58.0742 318.798 58.8236C318.798 59.6612 318.997 60.3225 319.394 60.8074C319.834 61.2923 320.429 61.5348 321.179 61.5348C321.752 61.5348 322.325 61.4025 322.898 61.138C323.515 60.8735 324 60.6311 324.353 60.4106L325.345 61.7993C324.904 62.5487 324.331 63.4083 323.626 64.3782C322.92 65.3039 322.171 66.1415 321.377 66.8909C320.584 67.5963 319.79 68.0592 318.997 68.2796ZM307.028 61.7332C307.689 61.7332 308.461 61.5568 309.342 61.2042C310.268 60.8074 311.084 60.3445 311.789 59.8155L311.987 53.5336L304.912 55.5174C303.854 55.8259 303.325 56.5533 303.325 57.6995C303.325 58.8457 303.656 59.8155 304.317 60.609C305.022 61.3584 305.926 61.7332 307.028 61.7332Z" fill="black"/>
      <path d="M285.403 68.2796C282.273 68.2796 279.981 67.6183 278.526 66.2958C277.071 64.9733 276.344 62.9234 276.344 60.1462V45.4002C276.344 44.0336 276.101 43.1078 275.616 42.6229C275.131 42.138 274.184 41.8735 272.773 41.8294L272.112 41.3665L272.575 38.1264C273.985 37.4651 275.352 36.7377 276.674 35.9442C277.997 35.1066 279.165 34.3352 280.179 33.6298C281.237 32.8804 282.075 32.2853 282.692 31.8445C283.309 31.3595 283.618 31.1171 283.618 31.1171L285.469 32.0428C285.469 32.0428 285.381 32.5498 285.205 33.5637C285.072 34.5336 284.918 35.9222 284.742 37.7296L292.545 37.5313L292.809 37.8619L292.148 42.2923L284.345 42.0939C284.213 43.9895 284.103 46.1496 284.014 48.5742C283.97 50.9547 283.948 53.5997 283.948 56.5093C283.948 58.4049 284.279 59.7715 284.94 60.609C285.601 61.4466 286.681 61.8654 288.18 61.8654C289.15 61.8654 290.054 61.7111 290.891 61.4025C291.729 61.094 292.148 60.9397 292.148 60.9397L293.007 63.0557C293.007 63.0557 292.699 63.3202 292.082 63.8492C291.509 64.3782 290.781 64.9954 289.9 65.7007C289.062 66.362 288.224 66.9571 287.387 67.4861C286.549 68.0151 285.888 68.2796 285.403 68.2796Z" fill="black"/>
      <path d="M257.9 68.2796C254.815 68.2796 252.148 67.6624 249.899 66.4281C247.695 65.1937 245.976 63.4304 244.742 61.138C243.551 58.8457 242.956 56.1566 242.956 53.0707C242.956 50.6461 243.353 48.4199 244.146 46.392C244.94 44.3642 246.042 42.6009 247.453 41.102C248.863 39.5591 250.516 38.3688 252.412 37.5312C254.308 36.6496 256.358 36.2087 258.562 36.2087C265.968 36.2087 269.671 39.9558 269.671 47.4501C269.671 48.1113 269.605 48.7946 269.472 49.4999C269.384 50.2053 269.296 50.7563 269.208 51.1531L268.414 51.9466H251.288C251.376 54.9884 252.081 57.3689 253.404 59.0881C254.771 60.7633 256.666 61.6891 259.091 61.8654C261.515 62.0417 264.359 61.3805 267.621 59.8816L268.084 60.1461L269.142 63.3863C268.26 64.0475 267.158 64.7749 265.836 65.5684C264.513 66.3179 263.146 66.9571 261.736 67.4861C260.325 68.0151 259.047 68.2796 257.9 68.2796ZM251.288 48.3097L260.347 47.7807C260.876 47.7366 261.207 47.6264 261.339 47.4501C261.515 47.2296 261.603 46.8329 261.603 46.2598C261.603 44.6728 261.251 43.4605 260.545 42.6229C259.84 41.7853 258.804 41.3665 257.438 41.3665C255.718 41.3665 254.308 41.9616 253.206 43.1519C252.148 44.2981 251.508 46.0173 251.288 48.3097Z" fill="black"/>
      <path d="M227.356 68.2796C224.27 68.2796 221.603 67.6624 219.355 66.4281C217.151 65.1937 215.432 63.4304 214.197 61.138C213.007 58.8457 212.412 56.1566 212.412 53.0707C212.412 50.6461 212.809 48.4199 213.602 46.392C214.396 44.3642 215.498 42.6009 216.908 41.102C218.319 39.5591 219.972 38.3688 221.868 37.5312C223.763 36.6496 225.813 36.2087 228.017 36.2087C235.423 36.2087 239.126 39.9558 239.126 47.4501C239.126 48.1113 239.06 48.7946 238.928 49.4999C238.84 50.2053 238.752 50.7563 238.664 51.1531L237.87 51.9466H220.744C220.832 54.9884 221.537 57.3689 222.86 59.0881C224.226 60.7633 226.122 61.6891 228.546 61.8654C230.971 62.0417 233.814 61.3805 237.077 59.8816L237.539 60.1461L238.597 63.3863C237.716 64.0475 236.614 64.7749 235.291 65.5684C233.969 66.3179 232.602 66.9571 231.191 67.4861C229.781 68.0151 228.502 68.2796 227.356 68.2796ZM220.744 48.3097L229.803 47.7807C230.332 47.7366 230.662 47.6264 230.795 47.4501C230.971 47.2296 231.059 46.8329 231.059 46.2598C231.059 44.6728 230.707 43.4605 230.001 42.6229C229.296 41.7853 228.26 41.3665 226.893 41.3665C225.174 41.3665 223.763 41.9616 222.661 43.1519C221.603 44.2981 220.964 46.0173 220.744 48.3097Z" fill="black"/>
      <path d="M180.594 68.5441C179.272 64.268 177.971 60.2123 176.693 56.377C175.414 52.4976 174.224 48.971 173.122 45.7969C172.02 42.5788 171.072 39.8456 170.279 37.5974H169.75C169.75 37.9941 169.705 38.8097 169.617 40.044C169.529 41.2784 169.419 42.7331 169.287 44.4083C169.198 46.0835 169.088 47.8468 168.956 49.6983C168.824 51.5058 168.692 53.2471 168.559 54.9222C168.471 56.5533 168.383 57.942 168.295 59.0881C168.251 60.2343 168.229 60.9397 168.229 61.2042C168.229 62.6148 168.934 63.3202 170.345 63.3202C170.609 63.3202 171.028 63.3202 171.601 63.3202C172.174 63.2761 172.505 63.2541 172.593 63.2541L172.99 63.5847L172.262 67.7506C171.821 67.7506 171.094 67.7285 170.08 67.6845C169.11 67.6404 168.096 67.5963 167.038 67.5522C166.024 67.5081 165.187 67.4861 164.526 67.4861C163.997 67.4861 163.357 67.5081 162.608 67.5522C161.859 67.5963 161.131 67.6624 160.426 67.7506C159.72 67.8388 159.125 67.9049 158.64 67.949C158.2 67.993 157.979 68.0151 157.979 68.0151L158.376 63.7169C159.698 63.5847 160.624 63.1879 161.153 62.5267C161.726 61.8213 162.145 60.6311 162.41 58.9559C162.498 58.471 162.608 57.5232 162.74 56.1125C162.872 54.7018 163.027 53.0266 163.203 51.087C163.424 49.1473 163.622 47.1635 163.798 45.1357C164.019 43.0637 164.217 41.102 164.393 39.2505C164.614 37.399 164.768 35.8561 164.856 34.6217C164.988 33.3433 165.055 32.5718 165.055 32.3073C165.055 31.4697 164.9 30.8526 164.592 30.4558C164.327 30.015 163.82 29.6844 163.071 29.4639C162.366 29.1994 161.352 29.0231 160.029 28.9349L159.698 28.5382L160.294 24.7029C161.043 24.747 161.947 24.7911 163.005 24.8352C164.063 24.8792 165.099 24.9233 166.113 24.9674C167.127 25.0115 167.942 25.0335 168.559 25.0335C169.309 25.0335 170.124 25.0335 171.006 25.0335C171.932 24.9894 172.813 24.9454 173.651 24.9013C174.489 24.8572 175.128 24.8131 175.569 24.769C176.494 28.1194 177.42 31.3155 178.346 34.3572C179.272 37.3549 180.109 40.0881 180.859 42.5568C181.652 45.0255 182.313 47.1194 182.842 48.8387C183.415 50.558 183.812 51.7703 184.033 52.4756H184.562C184.782 51.8143 185.157 50.6241 185.686 48.9048C186.259 47.1856 186.942 45.0916 187.736 42.6229C188.573 40.1542 189.477 37.421 190.447 34.4234C191.417 31.4257 192.409 28.2737 193.422 24.9674C194.04 24.9674 194.789 24.9894 195.671 25.0335C196.596 25.0776 197.544 25.0997 198.514 25.0997C199.484 25.0997 200.388 25.0776 201.225 25.0335C201.931 25.0335 202.768 25.0115 203.738 24.9674C204.752 24.8792 205.656 24.8131 206.449 24.769C207.243 24.6809 207.75 24.6368 207.97 24.6368L208.235 24.9013L207.838 28.8688C205.986 29.0011 204.708 29.3317 204.003 29.8607C203.297 30.3456 202.945 31.1832 202.945 32.3735C202.945 32.9465 202.967 33.9164 203.011 35.283C203.099 36.6496 203.187 38.2586 203.275 40.1101C203.407 41.9176 203.54 43.8572 203.672 45.9292C203.848 47.957 204.003 49.9628 204.135 51.9466C204.267 53.8863 204.399 55.6496 204.532 57.2366C204.84 59.6612 205.193 61.2923 205.59 62.1299C205.986 62.9234 206.714 63.3202 207.772 63.3202C208.124 63.3202 208.499 63.2981 208.896 63.2541C209.293 63.21 209.535 63.1879 209.623 63.1879L209.888 63.5186L209.293 67.6845C209.028 67.6845 208.499 67.6624 207.706 67.6183C206.956 67.5743 206.096 67.5302 205.127 67.4861C204.201 67.4861 203.363 67.4861 202.614 67.4861C201.864 67.4861 200.983 67.5081 199.969 67.5522C198.955 67.5963 197.941 67.6624 196.927 67.7506C195.913 67.8388 195.054 67.9049 194.348 67.949C193.643 67.993 193.268 68.0151 193.224 68.0151L193.687 63.7169C195.009 63.5406 195.957 63.21 196.53 62.725C197.103 62.196 197.39 61.4246 197.39 60.4107C197.39 60.058 197.346 59.3747 197.258 58.3608C197.214 57.3468 197.125 56.1125 196.993 54.6577C196.905 53.203 196.817 51.638 196.729 49.9628C196.641 48.2877 196.53 46.6566 196.398 45.0696C196.31 43.4825 196.222 42.0278 196.134 40.7053C196.045 39.3828 196.001 38.3468 196.001 37.5974H195.406C194.789 39.2725 194.106 41.2122 193.356 43.4164C192.607 45.6206 191.769 48.0452 190.844 50.6902C189.918 53.3352 188.97 56.1125 188 59.022C187.03 61.9315 186.06 64.9072 185.091 67.949L180.594 68.5441Z" fill="black"/>
    </svg>
  );
}

function MicIcon() {
  return (
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
      <path d="M12 2a3 3 0 0 0-3 3v7a3 3 0 0 0 6 0V5a3 3 0 0 0-3-3Z" />
      <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
      <line x1="12" x2="12" y1="19" y2="22" />
    </svg>
  );
}

function StopIcon() {
  return (
    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
      <rect x="6" y="6" width="12" height="12" rx="1" />
    </svg>
  );
}

function PasteIcon() {
  return (
    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
      <rect x="8" y="2" width="8" height="4" rx="1" ry="1" />
      <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2" />
    </svg>
  );
}
